"use client";

import { useState, useRef } from "react";
import { useGoogleReCaptcha } from "react-google-recaptcha-v3";

import { verifyReCaptcha, handleSubmit } from "@/actions";
import { Button } from "./ui/button";
import { Input } from "./ui/input";
import { Label } from "./ui/label";
import { Textarea } from "./ui/textarea";

export default function ContactForm() {
  const { executeRecaptcha } = useGoogleReCaptcha();
  const [loading, setLoading] = useState(false);
  const [submitted, setSubmitted] = useState(false);

  const formRef = useRef<HTMLFormElement>(null);

  async function onSubmit(event: React.FormEvent<HTMLFormElement>) {
    event.preventDefault();

    if (!executeRecaptcha) {
      alert("Failed to submit form ðŸš€");
      return;
    }
    setLoading(true);

    const reCaptchaToken = await executeRecaptcha("contact_form");
    const reCaptchaResponse = await verifyReCaptcha(reCaptchaToken);

    if (!reCaptchaResponse.body.success) {
      console.error("reCaptcha failed");
      alert("reCaptcha failed");
      setLoading(false);
      return;
    }

    const formData = new FormData(event.currentTarget);
    const response = await handleSubmit(formData);

    if (!response) {
      alert("Failed to submit form");
      setLoading(false);
    }

    if (response instanceof Error) {
      alert(response.message);
      setLoading(false);
    }

    if (response) {
      formRef.current?.reset();
      setLoading(false);
      setSubmitted(true);
    }
  }
  return (
    <>
      {!submitted ? (
        <form
          className="animate-slidein [--slidein-delay:700ms] opacity-0 max-w-screen-sm flex flex-col gap-2 m-auto"
          onSubmit={onSubmit}
          ref={formRef}
        >
          <div className="flex flex-col md:flex-row gap-2">
            <div className="w-full">
              <Label htmlFor="name" className="cursor-pointer">
                Your Name
              </Label>
              <Input
                id="name"
                name="name"
                type="text"
                placeholder="Name"
                className="mt-1 "
                required
              />
            </div>
            <div className="w-full group">
              <Label htmlFor="email" className="cursor-pointer">
                Your Email
              </Label>
              <Input
                id="email"
                name="email"
                type="email"
                placeholder="Email"
                className="mt-1 "
                required
              />
            </div>
          </div>
          <Input name="_gotcha" type="text" className="hidden" />
          <Label htmlFor="message" className="cursor-pointer">
            Message
          </Label>
          <Textarea
            id="message"
            name="message"
            placeholder="Message"
            className="mt-1 "
            required
          />
          <Button
            type="submit"
            variant="ringHover"
            size="lg"
            className="mt-4 w-fit"
            disabled={loading}
          >
            {loading ? "Submitting..." : "Submit"}
          </Button>
        </form>
      ) : (
        <div className="max-w-[470px] flex flex-col gap-4 m-auto text-center items-center">
          <h2 className="animate-slidein [--slidein-delay:300ms] opacity-0 text-4xl">
            Thank you for your enquiry!
          </h2>
          <p className="animate-slidein [--slidein-delay:300ms] opacity-0">
            Please check your email for a confirmation of your enquiry. Julia
            will be in touch soon.
          </p>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 128 128"
            width="128"
            height="128"
            preserveAspectRatio="xMidYMid meet"
            className="animate-slidein [--slidein-delay:700ms] opacity-0"
            style={{
              width: "100px",
              height: "100px",
              transform: "translate3d(0px, 0px, 0px)",
              contentVisibility: "visible",
            }}
            id="Verified"
          >
            <defs>
              <clipPath id="__lottie_element_3629">
                <rect width="128" height="128" x="0" y="0" />
              </clipPath>
            </defs>
            <g clip-path="url(#__lottie_element_3629)">
              <g
                transform="matrix(0.9999135732650757,0.013144899159669876,-0.013144899159669876,0.9999135732650757,10.577327728271484,9.15402603149414)"
                opacity="1"
                className="block"
              >
                <g
                  opacity="1"
                  transform="matrix(1,0,0,1,54.138999938964844,54.138999938964844)"
                >
                  <path
                    stroke-linecap="butt"
                    stroke-linejoin="miter"
                    fill-opacity="0"
                    stroke-miterlimit="4"
                    stroke="rgb(0,0,0)"
                    stroke-opacity="1"
                    stroke-width="7"
                    d=" M-11.3149995803833,-41.356998443603516 C-9.819000244140625,-42.63199996948242 -9.071999549865723,-43.26900100708008 -8.354000091552734,-43.75 C-3.299999952316284,-47.138999938964844 3.3010001182556152,-47.138999938964844 8.354999542236328,-43.75 C9.071999549865723,-43.26900100708008 9.819999694824219,-42.63199996948242 11.315999984741211,-41.356998443603516 C11.911999702453613,-40.8489990234375 12.208999633789062,-40.595001220703125 12.512999534606934,-40.36199951171875 C14.604000091552734,-38.75699996948242 17.079999923706055,-37.73099899291992 19.69300079345703,-37.38800048828125 C20.07200050354004,-37.3380012512207 20.46299934387207,-37.30699920654297 21.243000030517578,-37.244998931884766 C23.20199966430664,-37.0880012512207 24.180999755859375,-37.0099983215332 25.02899932861328,-36.84299850463867 C30.999000549316406,-35.66600036621094 35.66699981689453,-30.999000549316406 36.84299850463867,-25.027999877929688 C37.01100158691406,-24.180999755859375 37.0890007019043,-23.201000213623047 37.244998931884766,-21.243000030517578 C37.30699920654297,-20.461999893188477 37.3380012512207,-20.07200050354004 37.38800048828125,-19.691999435424805 C37.731998443603516,-17.07900047302246 38.75699996948242,-14.602999687194824 40.36199951171875,-12.512999534606934 C40.595001220703125,-12.208999633789062 40.8489990234375,-11.91100025177002 41.356998443603516,-11.3149995803833 C42.63199996948242,-9.819000244140625 43.26900100708008,-9.071999549865723 43.75,-8.354000091552734 C47.138999938964844,-3.299999952316284 47.138999938964844,3.3010001182556152 43.75,8.354999542236328 C43.26900100708008,9.071999549865723 42.63199996948242,9.819999694824219 41.356998443603516,11.315999984741211 C40.8489990234375,11.91100025177002 40.595001220703125,12.208999633789062 40.36199951171875,12.512999534606934 C38.75699996948242,14.604000091552734 37.731998443603516,17.079999923706055 37.38800048828125,19.69300079345703 C37.3380012512207,20.07200050354004 37.30699920654297,20.46299934387207 37.244998931884766,21.243000030517578 C37.0890007019043,23.20199966430664 37.01100158691406,24.180999755859375 36.84299850463867,25.02899932861328 C35.66699981689453,30.999000549316406 30.999000549316406,35.66600036621094 25.02899932861328,36.84299850463867 C24.180999755859375,37.01100158691406 23.20199966430664,37.0890007019043 21.243000030517578,37.244998931884766 C20.46299934387207,37.30699920654297 20.07200050354004,37.3380012512207 19.69300079345703,37.38800048828125 C17.079999923706055,37.731998443603516 14.604000091552734,38.75699996948242 12.512999534606934,40.36199951171875 C12.208999633789062,40.595001220703125 11.911999702453613,40.8489990234375 11.315999984741211,41.356998443603516 C9.819999694824219,42.63199996948242 9.071999549865723,43.26900100708008 8.354999542236328,43.75 C3.3010001182556152,47.138999938964844 -3.299999952316284,47.138999938964844 -8.354000091552734,43.75 C-9.071999549865723,43.26900100708008 -9.819000244140625,42.63199996948242 -11.3149995803833,41.356998443603516 C-11.91100025177002,40.8489990234375 -12.208999633789062,40.595001220703125 -12.512999534606934,40.36199951171875 C-14.602999687194824,38.75699996948242 -17.07900047302246,37.731998443603516 -19.691999435424805,37.38800048828125 C-20.07200050354004,37.3380012512207 -20.461999893188477,37.30699920654297 -21.243000030517578,37.244998931884766 C-23.201000213623047,37.0890007019043 -24.180999755859375,37.01100158691406 -25.027999877929688,36.84299850463867 C-30.999000549316406,35.66600036621094 -35.66600036621094,30.999000549316406 -36.84299850463867,25.02899932861328 C-37.0099983215332,24.180999755859375 -37.0880012512207,23.20199966430664 -37.244998931884766,21.243000030517578 C-37.30699920654297,20.46299934387207 -37.3380012512207,20.07200050354004 -37.38800048828125,19.69300079345703 C-37.73099899291992,17.079999923706055 -38.75699996948242,14.604000091552734 -40.36199951171875,12.512999534606934 C-40.595001220703125,12.208999633789062 -40.8489990234375,11.91100025177002 -41.356998443603516,11.315999984741211 C-42.63199996948242,9.819999694824219 -43.26900100708008,9.071999549865723 -43.75,8.354999542236328 C-47.138999938964844,3.3010001182556152 -47.138999938964844,-3.299999952316284 -43.75,-8.354000091552734 C-43.26900100708008,-9.071999549865723 -42.63199996948242,-9.819000244140625 -41.356998443603516,-11.3149995803833 C-40.8489990234375,-11.91100025177002 -40.595001220703125,-12.208999633789062 -40.36199951171875,-12.512999534606934 C-38.75699996948242,-14.602999687194824 -37.73099899291992,-17.07900047302246 -37.38800048828125,-19.691999435424805 C-37.3380012512207,-20.07200050354004 -37.30699920654297,-20.461999893188477 -37.244998931884766,-21.243000030517578 C-37.0880012512207,-23.201000213623047 -37.0099983215332,-24.180999755859375 -36.84299850463867,-25.027999877929688 C-35.66600036621094,-30.999000549316406 -30.999000549316406,-35.66600036621094 -25.027999877929688,-36.84299850463867 C-24.180999755859375,-37.0099983215332 -23.201000213623047,-37.0880012512207 -21.243000030517578,-37.244998931884766 C-20.461999893188477,-37.30699920654297 -20.07200050354004,-37.3380012512207 -19.691999435424805,-37.38800048828125 C-17.07900047302246,-37.73099899291992 -14.602999687194824,-38.75699996948242 -12.512999534606934,-40.36199951171875 C-12.208999633789062,-40.595001220703125 -11.91100025177002,-40.8489990234375 -11.3149995803833,-41.356998443603516z"
                  />
                </g>
              </g>
              <g
                transform="matrix(1,0,0,1,44,49.000003814697266)"
                opacity="1"
                className="block"
              >
                <g
                  opacity="1"
                  transform="matrix(1,0,0,1,21.5,15.800000190734863)"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    fill-opacity="0"
                    stroke="rgb(0,0,0)"
                    stroke-opacity="1"
                    stroke-width="7"
                    d=" M-14.5,1.2000000476837158 C-14.5,1.2000000476837158 -9.243000030517578,6.456999778747559 -9.243000030517578,6.456999778747559 C-6.900000095367432,8.800000190734863 -3.0999999046325684,8.800000190734863 -0.7570000290870667,6.456999778747559 C-0.7570000290870667,6.456999778747559 12.385000228881836,-6.684999942779541 14.274999618530273,-8.574999809265137"
                  />
                </g>
              </g>
            </g>
          </svg>
        </div>
      )}
    </>
  );
}
